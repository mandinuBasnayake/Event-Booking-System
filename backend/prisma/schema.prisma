// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - will be expanded in Phase 2
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bookings Booking[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// Event model - will be expanded in Phase 3
model Event {
  id          String   @id @default(uuid())
  title       String
  description String
  imageUrl    String?
  startDate   DateTime
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String

  @@map("events")
}

// Venue model - seating layouts
model Venue {
  id        String   @id @default(uuid())
  name      String
  address   String
  city      String
  capacity  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events Event[]
  seats  Seat[]

  @@map("venues")
}

// Seat model - individual seats
model Seat {
  id         String     @id @default(uuid())
  seatNumber String
  section    String
  row        String
  seatType   SeatType   @default(STANDARD)
  price      Float
  status     SeatStatus @default(AVAILABLE)
  version    Int        @default(0) // For optimistic locking
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  venue   Venue  @relation(fields: [venueId], references: [id])
  venueId String

  bookings Booking[]

  @@unique([venueId, seatNumber])
  @@map("seats")
}

enum SeatType {
  VIP
  PREMIUM
  STANDARD
  BUDGET
}

enum SeatStatus {
  AVAILABLE
  RESERVED
  SOLD
  BLOCKED
}

// Booking model - ticket reservations
model Booking {
  id              String        @id @default(uuid())
  bookingNumber   String        @unique
  status          BookingStatus @default(PENDING)
  totalPrice      Float
  reservedAt      DateTime      @default(now())
  confirmedAt     DateTime?
  expiresAt       DateTime // Auto-release after timeout
  paymentIntentId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  userId String

  seat   Seat   @relation(fields: [seatId], references: [id])
  seatId String

  @@index([status])
  @@index([expiresAt])
  @@map("bookings")
}

enum BookingStatus {
  PENDING   // Reserved but not paid
  CONFIRMED // Payment confirmed
  CANCELLED // Cancelled by user
  EXPIRED   // Reservation timeout
}
